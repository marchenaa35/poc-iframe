<!doctype html>
<meta charset="utf-8">
<title>open-window PoC — postMessage</title>
<body style="font-family:system-ui;padding:18px">
  <h2>Open-window PoC</h2>
  <p>Abre la página objetivo en una nueva ventana y envía postMessage desde tu dominio (sin usar iframe).</p>

  <label style="display:block;margin-bottom:8px">
    Target (URL a abrir):
    <input id="t" value="https://www.myfitnesspal.com/apps" style="width:70%;margin-left:8px"/>
  </label>

  <p>
    <button id="o">Open target (new window)</button>
    <button id="s" disabled>Send postMessage (ping)</button>
  </p>

  <pre id="log" style="background:#f6f8fa;padding:8px;height:180px;overflow:auto">log</pre>

  <script>
    let w;
    const logEl = document.getElementById('log');
    function log(m){ logEl.textContent += '\\n' + new Date().toISOString() + ' ' + m; logEl.scrollTop = logEl.scrollHeight; }

    document.getElementById('o').addEventListener('click', () => {
      const url = document.getElementById('t').value.trim();
      if (!url) return alert('Introduce target URL');
      // abrir en nueva ventana/pestaña
      w = window.open(url, '_blank');
      log('opened ' + url + ' (allow popup if blocked)');
      // dar tiempo a que la ventana cargue y habilitar el botón send
      setTimeout(() => { document.getElementById('s').disabled = false; }, 1500);
    });

    document.getElementById('s').addEventListener('click', () => {
      if (!w || w.closed) { alert('Ventana no disponible. Vuelve a abrirla.'); return; }
      const payload = { __tcfapiCall: { command: "ping", version: 2, callId: "poc-openwin" } };
      try {
        w.postMessage(JSON.stringify(payload), '*');
        log('sent payload: ' + JSON.stringify(payload));
      } catch (err) {
        log('send error: ' + err);
      }
    });

    // para recibir mensajes de vuelta (opcional)
    window.addEventListener('message', e => {
      log('recv from ' + e.origin + ' data=' + (typeof e.data === 'string' ? e.data : JSON.stringify(e.data)));
    }, false);
  </script>
</body>
